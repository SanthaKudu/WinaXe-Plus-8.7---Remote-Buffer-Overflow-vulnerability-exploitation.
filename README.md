# WinaXe-Plus-8.7---Remote-Buffer-Overflow-vulnerability-exploitation.

About software

WinaXe is the pre-eminent X Windows environment for the MS Windows 9x/ME/NT4/2K/2K3/XP/Vista/Windows 7 platforms. It enables easy access to different operating systems. WinaXe Windows X Server transparently connects different operating systems and their applications together. You need not worry where these applications are physically located on your network. WinaXe brings remote UNIX applications to your PC with each in a separate window. There are no discernible differences when compared to local PC applications which run simultaneously with those from the host / remote system.

This software consisting with an component call FTP which allow users to connect FTP servers with credential and manage profiles.

VULNERABILITY…..

Lets Try to communicate with Application from my Host pc

We can do this using simple python script.

![](RackMultipart20200513-4-leh82e_html_74d3186d07670680.jpg)

Figure 1

If you send any string without starting from number FTP dosent read that data properly.So we can append number initially and send the string as bytes to FTP application.

So first Run the script and initiate the server,Then switch to the windows VM and open ftp Application and connect to this server.We need to provide host ip as Host Machine Ip address.So since Ftp port is 21.

![](img/script001.jpg)

Figure 2

Yes,As the Above Image we can see that Application is successfully collecting Data which we send.So Lets Try to send more data to FTP Application.

Change the 0HELLO to some thing like this 0HELLOAAAAAAAAAAAAAAAAAAAAA.

And rerun the script and connect again From FTP Application.

![](RackMultipart20200513-4-leh82e_html_e3576e5c675aa42.jpg)

Figure 3

As we expected The Application able to hold all the data that we send to him.So the is there any limit,for holding data ? Lets find out it.We can modify the above script as following image.

![](RackMultipart20200513-4-leh82e_html_15e88e9b7f14144d.jpg)

Figure 4

Run the Script and Start the Server.Switch back to Windows 7 vm and connect From FTP to Out Script.Then Check the console for python script results.

![](RackMultipart20200513-4-leh82e_html_2af5a6e2147b6014.jpg)

Figure 5

And FTP Application will behave like this.

![](RackMultipart20200513-4-leh82e_html_adfcdea7a31133b4.jpg)

Figure 6

So lets continue by clicking connect button of FTP application.After few Attempts Application Will Crash.So Yes That is the Vulnerability of FTP,Stack Buffer overflow.

![](RackMultipart20200513-4-leh82e_html_395d2b00054d299b.jpg)

Figure 7

So Lets Check the Python Scripts results in the console.

F ![](RackMultipart20200513-4-leh82e_html_761bb7a00906dfc8.jpg) igure 8

Our scripts says FTP took around 2300 bytes it to crash.

Alight now we know this Application has some serious issue So Lets Try to make an custom Exploit to go through this Vulnerability.

Exploit Development

So we need Few tools

Immunity Debugger or WinD- Debugger or any that support for 32bit /x86 application debugging.

Im using Immiunity Debugger for this case.

Mona Python Script

First we have to Install Immunity Debugger on the Windows vm.Then unrar the Mona\_master and copy the mona.py to Pycommand folder Immunity Debugger Install Directory.

Now run Debugger as Administrator and open the FTP.exe

What is StackBuffer Overfow

Verygood explanation on here [https://www.coengoedegebure.com/buffer-overflow-attacks-explained/](https://www.coengoedegebure.com/buffer-overflow-attacks-explained/)

S ![](RackMultipart20200513-4-leh82e_html_94942276af28a140.png) o in simplest manner Buffer Overflowing means a variable in stack Frame will grow and overrides the high memory addresses.

Figure 9

In the above image clearly shows that buffer is growing on other higher addresses. Base pointer etc.So if we can put some thing on to buffer area that would override the base pointer and return address.Then the Memory layout would be like the below image.

![](RackMultipart20200513-4-leh82e_html_7772a230f7315ca8.png)

Figure 10

Now assume that BBBB is base ponter&#39;s address and CCCC is return address.So While Program executes EIP will points to the CCCC and looks for the data in memory of CCCC address.So then the Program will crashes because there will be invalid values in address of CCCC.FTP Application Also faced to same problem.It crashed because we had override its EIP pointer valued to some misleading value.

But instead of CCCCC address what if we can provide a memory address of another location of memory that contains some malicious code.So Then the Program will execute it without any problems.So to do that we need to find out a way to override EIP as we want.So lets Do it.

Figuring out how many bytes that would be need to hit the EBP and EIP?

If we can find this we can add our own value to eip and ebp.

Now we know app will crash nearly 2300 bytes of input.We need the exact point that we want to touch the EIP address.So we can do followings.

First we need some unique character pattern like this.

Ao3Ao4Ao5Ao6Ao7Ao8Ao9Ap0Ap1Ap2Ap3Ap4Ap5An0An1An2An3An4An5An6An7An8An9Ao0Ao1Ao2

Figure 11

We need around 2300 characters at least.

[can use any tools for generating pattern strings-rule is no same letter duals]

So lest modify out previous script using this strings.

![](RackMultipart20200513-4-leh82e_html_a08ec7d9521d10bb.jpg)

Figure 12

![](RackMultipart20200513-4-leh82e_html_aa9e32ba50cdc431.jpg)

Figure 13

Ok.Now lets run the Scripts and switch back to the Windows vm.Then Press play button of the Immunity Debugger and wait.The FPT Application Interface will Pops up and we have to Click the connect button while providing host name and others.

As soon as FTP tries to Connect,It will crash again.So lets take a look at our debugger.

![](RackMultipart20200513-4-leh82e_html_c2ca66125b49bb1b.jpg)

Figure 14

We can see something like above image at the bottom of the debugger interface.And also some this like below Image.

![](RackMultipart20200513-4-leh82e_html_f84b427d95ed7bed.jpg)

Figure 15

As we learn from earlier the reason for crash is overridden EIP.so We can clearly see debugger points out that too.EIP value is now 43397143 so when application will point to this memory address and crashes.So where does this value came from.Its from the data that we sent.Actually this is some part of our pattern string.Lets find out exactly witch portion.

And also ESP also overridden from our long string.check the ASCII value in front of the ESP.

Normally values stored in little endian format in registers.So we need to reverse them So the EIP is

43713943.So those are hex representation of ASCII values.So we can use on line ASCII table to find out exact values.[[https://ascii.cl/index.htm?content=html](https://ascii.cl/index.htm?content=html)]

So then EIP contains &quot;C9qC&quot; 4 character from our string.

![](RackMultipart20200513-4-leh82e_html_5df8214ee575f1c5.jpg)

Figure 16

I just used the search option of pycharm IDE so we can see the results on above image.

So Now I can find out exact char length that we need to touch EIP.So I delete rest from &quot;C9qC&quot; portion.So there will be remaining 2067 chars. Actually 2028 with the 0 of the beginning.

Now we know that we can reach EIP by sending 2028 length buffer to FTP Application.

Lets get confirm this.

So lets customize script again

First remover every thing from &quot;C9qC&quot; portion of the pattern string.

Then add the following variable to the code

regEip = b&#39;OOOO&#39;

Change the payloadR as this,

payloadR = (b&quot;0&quot; + pattern + regEip + b&#39;\r\n&#39;)

Ok.Now we havet to test again.Run the Script and Witch to the Windows 7.

Press the x button on the debbugger upper tool bar [button is located near the play button]

Then add again FTP.exe and press play.

FTP will open again and do connect and wait for crash.Check the debugger informations.

![](RackMultipart20200513-4-leh82e_html_a520529baffd33c3.jpg)
 ![](RackMultipart20200513-4-leh82e_html_85610d014c9be876.jpg)

Figure 17

As we expected 2067 characters enough to reach EIP,and the newly added &quot;oooo&quot; are perfectly placed on to EIP.So now we can Control the EIP as we want.But this buffer isn&#39;t able to override EBP.We cant any ASCII Symbols in front of EBP as we saw in earlier.That means our buffer string not enough to reach the EBP.

So lets increase it.

Lets change the Script as follows,

Add new variable bellow regEip = b&#39;OOOO&#39;

bufferEsp = b&#39;C&#39; \* 200

Change the payloadR as this,

payloadR = (b&quot;0&quot; + pattern + regEip + bufferEsp + b&#39;\r\n&#39;)

Done.Now same as previous step.re run the script,switch to win 7 and run FTP through debugger .press connect and wait fro crash.Then observe the debugger readings.

![](RackMultipart20200513-4-leh82e_html_bff77fd59ce18c88.jpg)
 ![](RackMultipart20200513-4-leh82e_html_606e9206d915c9d5.jpg)
 ![](RackMultipart20200513-4-leh82e_html_92d23d06d236561f.jpg)

Figure 18

Perfect every thing is align as we want.Now the EBP is also overridden by our buffer values.We can see C letters In front of ESP.EIP is also overridden by exact value the we provided.

Okay now Instead of address OOOO what if we can set value In EIP that could redirect to ESP, so that means reading the &quot;CCCC&quot;.Yes it will also crash but what if we can change CCCCCCCC…. to valid machine instructions.

So that means we can put some valid instruction among CCCCCCCCCCCCCCCCCCCCC.So that is the ideal place to Host the Shell code.We will deal it wit latter.

Befor that we have to do some few test on this.According to the Images 0370D4E8 is the stack pointer.So if we replace OOOO [4F4F4F4F] with 0370D4E8 Application execution should jump to ESP.Then It will try to Read CCCC as Instructions and will Crash.But if we change CCCCC portion into Some machine code there wont be a problem.

But still there is a problem.Actually we cant relay on that address it could be diffract in another OS versions etc.So exploit wont work.

So we need to Find a reliable way to do this.Jump to ESP is common instruction so we need to find out another DLL that has the same instruction we can use it.the Advantage is the addresses used by these DLL&#39;s are pretty static.So if we can find out an static address with Jump to ESP instruction we can use it in out exploit.

We can do it using mona.So lets do it.

Switch to the Win 7.After FTP get crashed type the following command on debugger

!mona modules

F ![](RackMultipart20200513-4-leh82e_html_1308af6188470d40.jpg)
 igure 19

The scroll down a bit.

F ![](RackMultipart20200513-4-leh82e_html_d3479326ac84c45d.jpg)
 igure 20

Select dll that has False for REBASe,SAFESEH,ASLR and others.Those are information about how it was compiled. This one was compiled with ASLR and DEP turned off. ASLR and DEP are protections against exactly the kind of attack we are making here. We are relying on the return address being the same every time the program loads. If ASLR and DEP were turned on, then they would not be the same.

Here I selected wcmdpa10.dll

Done.Then type following command

!mona jmp -r esp -m wcmdpa10.dll

![](RackMultipart20200513-4-leh82e_html_5dfccefb416d3e34.jpg)

Figure 21

So then we will have all the memory address that contains &quot; jmp esp&quot; instruction on wcmdpa10.dll.

Select any address ,Im going for 680743 F0

So now we have an address to override as EIP.So lets create this suitable for little endian format.

regEip = b&quot;\xF0\x43\x07\x68&quot;

We have to reverse it.

So assume in the ESP on figure 18,We cant exactly witch c is Starting the ESP address,It could be vary Some times it can trip over.So if we add some machine instruction instead for CCCCCCCCCCCCCC ,that instructions could trip over so we should give some room for ShellCode.

So we can add some NOPs in front of shell code.We have to add in some NOP&#39;s NOP&#39;s are &quot;No Operation&quot; commands, which tell the program to do nothing, and then move onto the next command. We need these at the front of Shell Code , and if we don&#39;t give it some space (say 16 NOP&#39;s) then it can trip over its own feet. We don&#39;t want that.

Okay.So remember the Pattern String of 2076 chars,we used to find EIP position.So new we know it so we can change pattern string as follows

bufferAChar = b&quot;A&quot; \* 2067

So we can get same amount of chars again,no problem.

Lets alter out python script little bit more.

Remove payloadR

Add followings

regEip = b&quot;\xF0\x43\x07\x68&quot; # Will Jump To ESP Throug Static Dll Adderss

rShell =b&quot;SOME SHELL CODE&quot;

nops = (b&#39;\x90&#39; \* 100)

payload = b&#39;0&#39; + bufferAChar + regEip + nops + rShell + b&#39;\r\n&#39;

So this is the layout of out exploit

payload = b&#39;0&#39; + bufferAChar + regEip + nops + rShell + b&#39;\r\n&#39;

The only thing that we need now is a Shell code.Before generate a Shell code we have to find out bad characters,to exclude from shell code

To findout badcars we need a all charset used for shellcodes like bellow image.Then place it as the nope+rShell

F ![](RackMultipart20200513-4-leh82e_html_c79dac3c805f9136.jpg)
 igure 22

So now payload should be like this

payload = b&#39;0&#39; + bufferAChar + regEip +badchars + b&#39;\r\n&#39;

Now run and grab the debugger results.

F ![](RackMultipart20200513-4-leh82e_html_4f4585a8c25b9b75.jpg)
 igure 23

If we look at the image care fully we can see there are few missing numbers after 09.That means that character dosent render properly so that why its bad character.if we add those in the shellcode ,shellcode also wont work.

\x0a is the the one after 09.so remove this from badchars list and do the test. Until remaining all will preview properly

So at the end there will be 3 bad-chars

\x0a,\x00,\x0d

So remember to exclude the generating shell code.

Okay Now its Time Generate Shellcode.

We can use

Msfvenom for that

Generating reverse shell for windows.

![](RackMultipart20200513-4-leh82e_html_97188e994f79e090.jpg)

Figure 24

F ![](RackMultipart20200513-4-leh82e_html_dd5549c8a9fe25b2.jpg)
 igure 25

Al right Now we have to include this to out final exploit code.So it should looks like this.

![](RackMultipart20200513-4-leh82e_html_4d18241f2ba06d77.jpg)

Figure 26
